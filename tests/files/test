
!
! Last configuration change at 16:18:38 CEST Thu Jul 13 2023 by EEM_user
!
version 16.9
no service pad
service tcp-keepalives-in
service tcp-keepalives-out
service timestamps debug datetime msec localtime show-timezone
service timestamps log datetime msec localtime show-timezone
service password-encryption
no service dhcp
no service password-recovery 
platform qfp utilization monitor load 80
platform punt-keepalive disable-kernel-core
platform qos match-statistics per-filter
platform qos match-statistics per-ace
platform usb disable
platform hardware throughput level 100000
!
hostname one-gv-2595bk-56
!
boot-start-marker
boot system bootflash:isr4300-universalk9.16.09.07.SPA.bin
boot-end-marker
!
!
vrf definition Mgmt-intf
 !
 address-family ipv4
 exit-address-family
 !
 address-family ipv6
 exit-address-family
!
logging buffered 16000
logging persistent size 276291584 immediate protected
no logging console
enable secret 9 $9$POwqhoOM8r1pQn$8U4/kV0afAGK9QxK0Y0dfOlN0y0a4.SrV/jCV2sc3Ag
!
aaa new-model
!
!
aaa authentication fail-message 
**************************************************************
*                                                            *
*                        Login Failed!                       *
*                                                            *
*               Unauthorized access to this                  *
*               system/network is prohibited.                *
*                                                            *
*                                                            *
**************************************************************

aaa authentication login default group tacacs+ enable
aaa authentication enable default group tacacs+ enable
aaa authorization console
aaa authorization exec default group tacacs+ if-authenticated 
aaa authorization commands 15 default group tacacs+ none 
aaa accounting exec default start-stop group tacacs+
aaa accounting commands 1 default start-stop group tacacs+
aaa accounting commands 15 default start-stop group tacacs+
!
!
!
!
!
!
aaa session-id common
clock timezone CET 1 0
clock summer-time CEST recurring last Sun Mar 2:00 last Sun Oct 3:00
no ip source-route
!
no ip bootp server
no ip domain lookup
ip domain name mrs
!
!
!
login on-success log
!
!
!
!
!
!
!
subscriber templating
vtp mode transparent
multilink bundle-name authenticated
!
!
!
!
!
license udi pid ISR4331/K9 sn FDO23070MG6
license accept end user agreement
no license smart enable
diagnostic bootup level minimal
!
spanning-tree extend system-id
!
!
!
!
redundancy
 mode none
!
controller Cellular 0/1/0
 no lte firmware auto-sim
 no lte gps enable
 lte modem link-recovery rssi onset-threshold -110
 lte modem link-recovery monitor-timer 20
 lte modem link-recovery wait-timer 10
 lte modem link-recovery debounce-count 6
!
!
!
track 1 ip sla 1 reachability
 delay down 30 up 30
!
track 180 ip sla 180
 delay down 180 up 180
!
no cdp run
!
class-map match-any management-traffic
 match access-group 166
!
policy-map policy-cbwfq
 class management-traffic
  bandwidth remaining percent 1 
  set ip dscp af21
 class class-default
  fair-queue
  random-detect
  random-detect ecn
policy-map shape-to-20
 class class-default
  shape average 19200000 76800 0 
   service-policy policy-cbwfq
!
!
!
!
!
!
interface Loopback0
 ip address 10.1.1.156 255.255.255.255
!
interface Tunnel10
 description 3G/4G backup to ONEM1160
 ip address 10.1.1.242 255.255.255.254
 ip tcp adjust-mss 1436
 keepalive 20 3
 tunnel source Cellular0/1/0
 tunnel destination 10.127.249.45
!
interface GigabitEthernet0/0/0
 description Connection to Epacity
 ip address 192.168.12.17 255.255.255.252
 media-type rj45
 speed 100
 no negotiation auto
 service-policy output shape-to-20
!
interface GigabitEthernet0/0/1
 no ip address
 negotiation auto
!
interface GigabitEthernet0/0/2
 no ip address
 negotiation auto
!
interface Cellular0/1/0
 description 145.7.64.247 Backup Link # cellular-ip:10.124.234.45 #
 ip address negotiated
 ip access-group block_addresses_to_cellular in
 load-interval 30
 dialer in-band
 dialer idle-timeout 0
 dialer watch-group 1
 dialer-group 1
 pulse-time 1
 service-policy output policy-cbwfq
 ip virtual-reassembly
!
interface Cellular0/1/1
 no ip address
 shutdown
!
interface GigabitEthernet0
 vrf forwarding Mgmt-intf
 no ip address
 shutdown
 negotiation auto
!
ip local policy route-map route-traffic-to-cellular-if
no ip forward-protocol nd
ip tcp window-size 65536
no ip http server
no ip http secure-server
no ip nat service sip tcp port 5060
no ip nat service sip udp port 5060
ip route 10.127.249.45 255.255.255.255 Null0 track 1
ip route 192.168.28.0 255.255.255.0 192.168.12.18 track 1
ip route 0.0.0.0 0.0.0.0 192.168.12.18 track 1
ip route 0.0.0.0 0.0.0.0 Tunnel10 5
ip route 0.0.0.0 0.0.0.0 Cellular0/1/0 15
ip route 10.127.249.45 255.255.255.255 Cellular0/1/0 10
ip route 145.7.64.247 255.255.255.255 Null0
ip route 145.13.71.128 255.255.255.128 192.168.12.18
ip route 145.13.76.0 255.255.255.0 192.168.12.18
ip route 192.168.28.0 255.255.255.0 Tunnel10 5
ip route 192.168.28.0 255.255.255.0 Null0 10
!
ip ssh time-out 60
ip ssh window-size 65536
ip ssh logging events
ip ssh version 2
ip ssh server algorithm mac hmac-sha2-512 hmac-sha2-256 hmac-sha1
ip scp server enable
!
!
ip access-list extended block_addresses_to_cellular
 deny   ip host 192.168.12.18 any
 permit ip any any
ip sla 1
 icmp-echo 192.168.12.18 source-interface Loopback0
 frequency 10
ip sla schedule 1 life forever start-time now
ip sla 180
 icmp-echo 145.7.64.247 source-interface Cellular0/1/0
 tos 192
 tag Test_mobile_connection
 frequency 30
ip sla schedule 180 life forever start-time now
logging history notifications
logging origin-id hostname
logging source-interface Loopback0
logging snmp-trap emergencies
logging snmp-trap alerts
logging snmp-trap critical
logging snmp-trap errors
logging snmp-trap warnings
logging snmp-trap notifications
logging host 192.168.28.66
access-list 2 deny   any
access-list 3 permit 193.172.69.107
access-list 3 permit 193.172.69.75
access-list 3 deny   any
access-list 10 permit 192.168.28.0 0.0.0.255
access-list 10 deny   any
access-list 14 permit 192.168.28.0 0.0.0.255
access-list 14 deny   any
access-list 93 permit 192.168.28.0 0.0.0.255
access-list 93 permit 145.13.71.128 0.0.0.127
access-list 93 permit 145.13.76.0 0.0.0.255
access-list 93 deny   any
ip access-list extended 103
 permit icmp any host 145.7.64.247
ip access-list extended 160
 deny   ip any 10.0.0.0 0.7.255.255
 deny   ip 10.0.0.0 0.7.255.255 any
 deny   ip any 192.168.28.0 0.0.0.255
 deny   ip 192.168.28.0 0.0.0.255 any
 deny   ip any 145.13.71.128 0.0.0.127
 deny   ip 145.13.71.128 0.0.0.127 any
 deny   ip any 145.13.76.0 0.0.0.255
 deny   ip 145.13.76.0 0.0.0.255 any
 permit ip any any
ip access-list extended 166
 permit ip host 10.1.1.156 192.168.28.0 0.0.0.255
 permit ip host 10.1.1.156 145.13.71.128 0.0.0.127
 permit ip host 10.1.1.156 145.13.76.0 0.0.0.255
 deny   ip any any
dialer watch-list 1 delay route-check initial 180
dialer watch-list 1 delay connect 1
dialer-list 1 protocol ip permit
!
!
route-map route-traffic-to-cellular-if permit 10 
 match ip address 103
 set interface Cellular0/1/0
!
snmp-server community g88hj53n RO 10
snmp-server community c13mw08m RO 93
snmp-server community 7QuIvTihXlxkEicZl8SAinw6 RO 93
snmp-server community SP54zG4QrV22vFDfKKZAFMbQ RO 93
snmp-server trap-source Loopback0
snmp-server enable traps event-manager
snmp-server enable traps syslog
snmp-server host 145.13.76.159 version 2c c13mw08m 
snmp-server host 145.13.76.33 version 2c c13mw08m 
snmp ifmib ifindex persist
tacacs server pri-acs
 address ipv4 192.168.28.191
 key 7 130E071C0A140D382437
!
!
!
!
control-plane
!
privilege exec level 1 traceroute
privilege exec level 1 ping
banner exec 
**************************************************************
*                                                            *
*   You have logged on to the KPN Managed VPN service.       *
*   Network management from The Hague, Netherlands.          *
*                                                            *
*   Use of this system/network is restricted to employees    *
*   of KPN, employment agency staff, work experience         *
*   trainees and persons with a contract of employment       *
*   provided that they are working for KPN and are           *
*   authorized to use the system.                            *
*                                                            *
*   The software and data in this system/network are owned   *
*   by KPN and may be viewed, changed, copied or deleted     *
*   only by authorized persons for the purpose of their      *
*   work for KPN.                                            *
*                                                            *
*   Use Ctrl z and quit to logout.                           *
*                                                            *
*                                                            *
**************************************************************

banner login 
**************************************************************
*      .                                                     *
*     / \        UNAUTHORISED ACCESS PROHIBITED !!           *
*    (kpn)                                                   *
*     \_/    Contact your kpn servicedesk for questions.     *
*                                                            *
**************************************************************

!
line con 0
 exec-timeout 9 0
 password 7 070A18564102103414035E22542F32750C1133361B012F3631
 transport preferred none
 transport input none
 transport output none
 stopbits 1
line aux 0
 no exec
 transport preferred none
 transport output none
 stopbits 1
line vty 0 4
 access-class 14 in
 exec-timeout 9 0
 password 7 144637395B150B787011630633272C403A02795A624978140D
 logging synchronous
 transport preferred none
 transport input ssh
 transport output none
!
ntp access-group peer 3
ntp access-group serve 2
ntp access-group serve-only 2
ntp access-group query-only 2
ntp server 193.172.69.75 prefer
ntp server 193.172.69.107
!
!
!
!
event manager session cli username "EEM_user"
event manager applet Cellular-Modem-24Hrs-Down-V12
 event track 180 state down maxrun 600
 trigger delay 86400
 action 101 track read 180
 action 102 if $_track_state eq "down"
 action 103  cli command "enable"
 action 104  cli command "show interfaces Cellular0/1/0"
 action 105  string match "*administratively*" "$_cli_result"
 action 106  if $_string_result eq "1"
 action 107   snmp-trap strdata "Cellular Interface is administratively Down, WOA_SNOW_Ticket"
 action 108   syslog priority notifications msg "Cellular Interface is administratively Down, WOA_SNOW_Ticket"
 action 109  else
 action 110   snmp-trap strdata "Mobile Connection is 24Hrs Down, WOA_SNOW_Ticket"
 action 111   syslog priority notifications msg "Mobile Connection is 24Hrs Down, WOA_SNOW_Ticket"
 action 112  end
 action 113 end
event manager applet Modem-Power-Cycle-V12
 event tag TRACK-180 track 180 state down
 event tag WATCHDOG-VERIFY-CELLULAR timer watchdog time 1440 maxrun 600
 trigger
  correlate event TRACK-180 or event WATCHDOG-VERIFY-CELLULAR
 action 201 track read 180
 action 202 if $_track_state eq "down"
 action 203  cli command "enable"
 action 204  cli command "show interfaces Cellular0/1/0"
 action 206  string match "*administratively*" "$_cli_result"
 action 207  if $_string_result eq "1"
 action 208   syslog priority notifications msg "Cellular Interface is Admin Down NO modem-power-cycle"
 action 209  else
 action 210   cli command "configure terminal"
 action 211   cli command "interface Cellular0/1/0"
 action 212   cli command "shutdown"
 action 213   wait 5
 action 214   cli command "no shutdown"
 action 215   cli command "exit"
 action 216   wait 5
 action 217   cli command "service internal"
 action 218   cli command "do test Cellular 0/1/0 modem-power-cycle"
 action 219   cli command "no service internal"
 action 220   cli command "end"
 action 221   syslog priority notifications msg "Mobile Connection is Down Modem_Power_Cycled"
 action 222   cli command "write memory"
 action 223  end
 action 224 end
event manager applet Cellular-Modem-1Hrs-Up-V12
 event track 180 state up maxrun 600
 trigger delay 3600
 action 301 track read 180
 action 302 if $_track_state eq "up"
 action 303  snmp-trap strdata "Cellular connection is working, WOA_SNOW_Ticket_Clear"
 action 304  syslog priority notifications msg "Cellular connection is working, WOA_SNOW_Ticket_Clear"
 action 305 end
!
end
